general:
  branches:
    only:
      - master

dependencies:
  override:
    - npm cache clean:
        parallel: true
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; nvm install $NODE_VERSION; rm -fr ./node_modules; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH npm cache clean; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH npm rebuild:
        parallel: true
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH npm install:
        parallel: true

test:
  override:
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH node ./tests/unit/utils/static-srv.js:
        background: true
        parallel: true
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH node ./tests/unit/utils/wait.js:
        background: true
        parallel: true
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH node ./bin/server/server.js:
        background: true
        parallel: true
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH node ./bin/server/server.js --native-runner --config tests/integration/conf/native/cbtr.json:
        background: true
        parallel: true
    - sleep 2:
        parallel: true
    - case $CIRCLE_NODE_INDEX in 1) sleep 150 ;; 2) sleep 300 ;; esac; NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH npm run eslint-unit-tests-cov:
        parallel: true
    - NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH npm run integration-tests:
        parallel: true
    - case $CIRCLE_NODE_INDEX in 1) sleep 150 ;; 2) sleep 300 ;; esac; NODE_VERSION=`echo ${!NODEVEREXPR}`; PATH=/opt/circleci/nodejs/$NODE_VERSION/bin:$PATH npm run functional-tests:
        parallel: true
